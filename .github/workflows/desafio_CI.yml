name: CI/CD â€” Desafio Pipeline

on:
  push:
    branches: [ main, master ]

permissions:
  contents: read

env:
  IMAGE_BASE_NAME: meu-projeto          # nome base local; pode mudar
  DOCKERFILE_PATH: ./python             # <--- ajusta aqui se sua pasta for outro nome

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.set-image.outputs.image }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show folder (debug)
        run: |
          echo "PWD: $(pwd)"
          echo "List root:"
          ls -la
          echo "List ${DOCKERFILE_PATH}:"
          ls -la "${{ env.DOCKERFILE_PATH }}" || true

      - name: Build Docker image (local)
        run: |
          TAG=${{ env.IMAGE_BASE_NAME }}:${{ github.run_number }}
          echo "Building image: $TAG (Dockerfile path = $DOCKERFILE_PATH)"
          docker build -t "$TAG" -f "${{ env.DOCKERFILE_PATH }}/Dockerfile" "${{ env.DOCKERFILE_PATH }}"

      - name: Save image to tar
        run: |
          TAG=${{ env.IMAGE_BASE_NAME }}:${{ github.run_number }}
          docker save -o image.tar "$TAG"

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-image
          path: image.tar

      - name: Set output image
        id: set-image
        run: |
          echo "image=${{ env.IMAGE_BASE_NAME }}:${{ github.run_number }}" >> $GITHUB_OUTPUT

  test:
    needs: build
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ needs.build.outputs.image }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built image artifact
        uses: actions/download-artifact@v4
        with:
          name: built-image
          path: .

      - name: Load Docker image
        run: |
          echo "Loading image ${IMAGE_NAME} from tar"
          docker load -i image.tar

      - name: List images (debug)
        run: docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

      - name: Run tests inside container
        run: |
          # Ajuste o comando abaixo se o seu teste for diferente
          docker run --rm ${IMAGE_NAME} /bin/sh -c "pytest -q || exit 1"

  push:
    needs: test
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ needs.build.outputs.image }}
      DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_USERNAME }}/desafio-devops
      DOCKERHUB_TAG: ${{ github.run_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built image artifact
        uses: actions/download-artifact@v4
        with:
          name: built-image
          path: .

      - name: Load Docker image
        run: docker load -i image.tar

      - name: Tag image for Docker Hub
        run: |
          docker tag ${IMAGE_NAME} ${DOCKERHUB_REPO}:${DOCKERHUB_TAG}
          docker tag ${IMAGE_NAME} ${DOCKERHUB_REPO}:latest

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push image to Docker Hub
        run: |
          docker push ${DOCKERHUB_REPO}:${DOCKERHUB_TAG}
          docker push ${DOCKERHUB_REPO}:latest