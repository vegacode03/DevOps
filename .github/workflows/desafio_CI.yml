name: CI/CD â€” Desafio Pipeline

on:
  push:
    branches: [ main, master ]

permissions:
  contents: read

env:
  IMAGE_BASE_NAME: desafio-devops         # nome base local; pode mudar
  DOCKERFILE_PATH: ./python             

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.set-image.outputs.image }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show folder (debug)
        run: |
          echo "PWD: $(pwd)"
          echo "List root:"
          ls -la
          echo "List ${DOCKERFILE_PATH}:"
          ls -la "${{ env.DOCKERFILE_PATH }}" || true

      - name: Build Docker image (local)
        run: |
          TAG=${{ env.IMAGE_BASE_NAME }}:${{ github.run_number }}
          echo "Building image: $TAG (Dockerfile path = $DOCKERFILE_PATH)"
          docker build -t "$TAG" -f "${{ env.DOCKERFILE_PATH }}/Dockerfile" "${{ env.DOCKERFILE_PATH }}"

      - name: Save image to tar
        run: |
          TAG=${{ env.IMAGE_BASE_NAME }}:${{ github.run_number }}
          docker save -o image.tar "$TAG"

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-image
          path: image.tar

      - name: Set output image
        id: set-image
        run: |
          echo "image=${{ env.IMAGE_BASE_NAME }}:${{ github.run_number }}" >> $GITHUB_OUTPUT

  test:
    needs: build
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ needs.build.outputs.image }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built image artifact
        uses: actions/download-artifact@v4
        with:
          name: built-image
          path: .

      - name: Load Docker image
        run: |
          echo "Loading image ${IMAGE_NAME} from tar"
          docker load -i image.tar

      - name: List images (debug)
        run: docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

      - name: Run unittest inside container
        run: |
          docker run --rm ${IMAGE_NAME} python -m unittest discover -v

  deploy:
      name: Deploy no Render (Api)
      needs: test
      runs-on: ubuntu-latest

      steps:
        - name: Deploy usando action do Render
          uses: johnbeynon/render-deploy-action@v0.0.3
          with:
            serviceId: srv-d4iebi63jp1c73fcot1g
            apiKey: ${{ secrets.LEONARDOSOARES }}
            clearCache: false

        - name: Acionar Deploy Hook no Render
          run: |
            curl -X POST "${{ secrets.HOOK_LEONARDOSOARES }}"
            echo "Sinal de deploy enviado ao Render."